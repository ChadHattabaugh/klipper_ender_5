[gcode_macro WIPE_LINE]
description: creates a wipe line to clear the nozzle before printing
gcode:
  {% set z = params.Z|default(0.25)|float %}
  {% set n = params.N|default(0.4)|float %}
  {% set e_tmp = params.NOZZLE_TEMP|default(200)|float %}

  SAVE_GCODE_STATE NAME=wipe_line_state
  {% if printer.toolhead.homed_axes != "xyz" %}
    {action_respond_info("Please home XYZ first")}
  {% else %}
    {% if printer.extruder.temperature < 170 %}
    	M104 S{e_tmp} ; set final nozzle temp
    	M109 S{e_tmp} ; wait for nozzle temp to stabilize
    {% endif %}
    M82
    G90
    G92 E0
    G1 X10 Y20 Z5 F3000
    G1 Z{z} F3000
    G1 X10 Y150 F1500 E10.83
    G1 X{n + 10.0 } F5000
    G1 Y22 F1500 E21.5
    G1 Y20 F5000   
  {% endif %}
  RESTORE_GCODE_STATE NAME=wipe_line_state


[gcode_macro START_PRINT]
description: Print initialization code used for all prints
gcode: 
	{% set e_tmp = params.NOZZLE_TEMP|default(200)|float %}
	{% set bed_tmp = params.BED_TEMP|default(60)|float %}
    {% set init_e_tmp = 170 %}

	G90 ; use absolute coordinates
	M140 S{bed_tmp} ; set final bed temp
	M104 S{init_e_tmp} ; set temporary nozzle temp to prevent oozing during homing
	G28 ;home
	BED_MESH_PROFILE LOAD=default
	M190 S{bed_tmp} ; wait for bed temp to stabilize
    M109 S{init_e_tmp} ; wait for nozzle to stableize
    WIPE_LINE NOZZLE_TEMP={e_tmp}
	M118 Printing...




[gcode_macro PRESENT_PRINT]
gcode: 
    G90
	{% set current_z = printer.toolhead.position.z|float %}
	{% set max_z = printer.configfile.config.stepper_z.position_max|float %}
    {% set new_z = current_z + 30.0 %}
	{% set new_y = printer.configfile.config.stepper_y.position_max|float %}
	{% set new_x = printer.configfile.config.stepper_x.position_max|float %}
	{% if new_z < max_z %}
		G1 Z{new_z} F300
    {% elif max_z - 2 > current_z %}
		{% set new_z = max_z - 2 %}
		 G1 Z{new_z} F300
	{% endif %}
    G1 X{new_x} Y{new_y} F3000
    M118 Here's you part


[gcode_macro END_PRINT]
description: stores the printhead and presnets the print when complete
gcode: 
    M118 Printing Complete
	PRESENT_PRINT
	M140 S0 ; turn off heatbed
	M104 S0 ; turn off temperature
	M107 ; turn off fan
	M84 X Y E ; disable motors


[gcode_shell_command BACKUP_KLIPPER]
command: bash /home/biqu/klipper-backup/script.sh
timeout: 90.0
verbose = True


[gcode_macro SAVE_CONFIG]
description: backups up the configuration changes before saving 
rename_existing: BASE_SAVE_CONFIG
gcode: 
	RUN_SHELL_COMMAND cmd=BACKUP_KLIPPER
    M118 Config Backed Up
    BASE_SAVE_CONFIG

[gcode_macro BACKUP_CONFIG]
description: backup configuration without reloading
gcode:
	RUN_SHELL_COMMAND cmd=BACKUP_KLIPPER
    M118 Config Backed Up

